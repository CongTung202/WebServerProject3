<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${nctProduct.nctProductName}">Product Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/nct-user-style.css}">
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">
    <!-- CSRF Meta Tags -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<body>
<div th:replace="~{fragments/nct-header :: header}"></div>

<div th:replace="~{fragments/nct-sidebar :: sidebar(activePage='products')}"></div>

<main class="main-content">
    <div class="product-detail-wrapper">
        <!-- Product Images -->
        <div class="product-image-container">
            <div class="main-image">
                <img th:src="${nctProduct.nctImageUrl}" th:alt="${nctProduct.nctProductName}" id="mainProductImage">
                <!-- Wishlist Button -->
                <button class="btn-wishlist" th:onclick="'addToWishlist(' + ${nctProduct.nctProductId} + ')'" title="Thêm vào yêu thích">
                    <i class="far fa-heart"></i>
                </button>
            </div>
        </div>



        <!-- Product Info -->
        <div class="product-info-detail">
            <h1 th:text="${nctProduct.nctProductName}">Product Name</h1>

            <div class="product-price-detail" th:text="${#numbers.formatDecimal(nctProduct.nctPrice, 0, 'COMMA', 0, 'POINT')} + ' đ'">
                Product Price
            </div>
            <div class="product-original-price-detail" th:if="${nctProduct.nctOriginalPrice != null and nctProduct.nctOriginalPrice > nctProduct.nctPrice}"
                 th:text="${#numbers.formatDecimal(nctProduct.nctOriginalPrice, 0, 'COMMA', 0, 'POINT')} + ' đ'">
                Original Price
            </div>

            <div class="product-stock"
                 th:classappend="${nctProduct.nctStockQuantity > 0 ? 'available' : 'out'}"
                 th:text="${nctProduct.nctStockQuantity > 0 ? 'Còn hàng: ' + nctProduct.nctStockQuantity : 'Hết hàng'}">
                Stock Status
            </div>

            <!-- Quantity Selector -->
            <div class="quantity-selector" th:if="${nctProduct.nctStockQuantity > 0}">
                <label for="quantity" class="form-label">Số lượng</label>
                <div class="quantity-input-wrapper">
                    <button class="quantity-btn" type="button" onclick="changeQuantity(-1)">-</button>
                    <input type="number" id="quantity" name="quantity" value="1" min="1" th:max="${nctProduct.nctStockQuantity}" class="form-input">
                    <button class="quantity-btn" type="button" onclick="changeQuantity(1)">+</button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons" th:if="${nctProduct.nctStockQuantity > 0}">
                <button class="btn btn-add-to-cart" th:onclick="'addToCart(' + ${nctProduct.nctProductId} + ')'">
                    <i class="fas fa-cart-plus"></i> Thêm vào giỏ hàng
                </button>
                <button class="btn btn-buy-now" th:onclick="'buyNow(' + ${nctProduct.nctProductId} + ')'">
                    <i class="fas fa-dollar-sign"></i> Mua ngay
                </button>
            </div>

            <div class="commitments">
                <h6>Cam kết từ NCT-Shop</h6>
                <ul>
                    <li><i class="fas fa-check-circle"></i>Sản phẩm chính hãng 100%.</li>
                    <li><i class="fas fa-truck"></i>Giao hàng hỏa tốc.</li>
                    <li><i class="fas fa-headset"></i>Hỗ trợ 24/7.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Related Products Section -->
    <div th:if="${nctRelatedProducts != null and !nctRelatedProducts.isEmpty()}" class="related-products">
        <h3>Sản phẩm liên quan</h3>
        <div class="product-grid">
            <!-- Loop through related products and create product cards -->
            <a th:each="relatedProduct : ${nctRelatedProducts}" th:href="@{/products/{id}(id=${relatedProduct.nctProductId})}" class="product-card">
                <div class="product-image">
                    <img th:src="${relatedProduct.nctImageUrl}" th:alt="${relatedProduct.nctProductName}">
                </div>
                <div class="product-info">
                    <h4 class="product-name" th:text="${relatedProduct.nctProductName}">Product Name</h4>
                    <div class="product-price" th:text="${#numbers.formatDecimal(relatedProduct.nctPrice, 0, 'COMMA', 0, 'POINT')} + ' đ'">
                        Product Price
                    </div>
                    <div class="product-original-price" th:if="${relatedProduct.nctOriginalPrice != null and relatedProduct.nctOriginalPrice > relatedProduct.nctPrice}"
                         th:text="${#numbers.formatDecimal(relatedProduct.nctOriginalPrice, 0, 'COMMA', 0, 'POINT')} + ' đ'">
                        Original Price
                    </div>
                    <div class="product-stock"
                         th:classappend="${relatedProduct.nctStockQuantity > 0 ? 'available' : 'out'}"
                         th:text="${relatedProduct.nctStockQuantity > 0 ? 'Còn hàng' : 'Hết hàng'}">
                        Stock Status
                    </div>
                </div>
            </a>
        </div>
    </div>
</main>
<div th:replace="~{fragments/nct-chat-model :: nct-chat-model(pageContext='product-detail', contextProduct=null)}"></div>
<div th:replace="~{fragments/nct-footer :: footer}"></div>

<div id="toast-container"></div>

<script>
    function changeQuantity(amount) {
        const quantityInput = document.getElementById('quantity');
        const currentValue = parseInt(quantityInput.value, 10);
        const maxStock = parseInt(quantityInput.getAttribute('max'), 10);
        let newValue = currentValue + amount;

        if (newValue < 1) {
            newValue = 1;
        }
        if (maxStock && newValue > maxStock) {
            newValue = maxStock;
        }
        quantityInput.value = newValue;
    }

    function getCsrfHeaders() {
        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        const headers = {
            'Content-Type': 'application/x-www-form-urlencoded',
        };
        headers[header] = token;
        return headers;
    }

    function addToCart(productId) {
        const quantity = document.getElementById('quantity').value;
        fetch('/cart/add', {
            method: 'POST',
            headers: getCsrfHeaders(),
            body: `productId=${productId}&quantity=${quantity}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message || 'Đã thêm sản phẩm vào giỏ hàng!');
                if (typeof updateCartCount === 'function') {
                    updateCartCount(data.cartCount);
                }
            } else {
                showToast(data.message || 'Có lỗi xảy ra, vui lòng thử lại.', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Không thể thêm vào giỏ hàng.', 'error');
        });
    }

    function buyNow(productId) {
        const quantity = document.getElementById('quantity').value;
        window.location.href = `/checkout/buy-now?productId=${productId}&quantity=${quantity}`;
    }

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        // Force a reflow to enable the transition
        toast.offsetHeight;

        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (container.contains(toast)) {
                    container.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }
function addToWishlist(productId) {
    fetch('/wishlist/add', {
        method: 'POST',
        headers: getCsrfHeaders(),
        body: `productId=${productId}`
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            const wishlistBtn = document.querySelector('.btn-wishlist');
            if(wishlistBtn) {
                wishlistBtn.classList.add('active');
                wishlistBtn.querySelector('i').classList.replace('far', 'fas');
            }
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const errorMessage = error.message || 'Không thể thêm vào danh sách yêu thích.';
        showToast(errorMessage, 'error');
    });
}

</script>

</body>
</html>
